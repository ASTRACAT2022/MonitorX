<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MonitorX by astracat</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .glass {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .hover-scale {
            transition: transform 0.2s ease-in-out;
        }
        .hover-scale:hover {
            transform: scale(1.02);
        }
        canvas {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 16px;
        }
    </style>
</head>
<body class="bg-black text-white font-sans">
    <div class="container mx-auto p-6 max-w-7xl">
        <h1 class="text-4xl font-bold mb-4 bg-clip-text text-transparent bg-gradient-to-r from-white to-gray-400">
            MonitorX by astracat
        </h1>

        <!-- Индикатор состояния -->
        <div class="mb-6 glass rounded-lg p-4 text-center">
            <h2 id="status-text" class="text-2xl font-semibold">Проверка состояния...</h2>
        </div>

        <!-- Форма для добавления сервиса -->
        <div class="mb-10 glass rounded-lg p-6 hover-scale">
            <h2 class="text-2xl font-semibold mb-4">Добавить сервис</h2>
            <form action="/add_service" method="POST" class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <input type="text" name="name" placeholder="Название сервиса" class="glass p-3 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-500" required>
                <input type="text" name="url" placeholder="URL (например, https://example.com)" class="glass p-3 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-500" required>
                <input type="text" name="ping_host" placeholder="Хост для пинга (например, example.com)" class="glass p-3 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-500" required>
                <button type="submit" class="bg-gradient-to-r from-gray-700 to-gray-900 text-white p-3 rounded-lg hover:bg-gray-800 transition">Добавить сервис</button>
            </form>
        </div>

        <!-- Список сервисов -->
        <div class="mb-10 glass rounded-lg p-6 hover-scale">
            <h2 class="text-2xl font-semibold mb-4">Мониторинг сервисов</h2>
            <div class="overflow-x-auto">
                <table class="w-full border-collapse">
                    <thead>
                        <tr class="text-gray-400">
                            <th class="p-3 text-left">Название</th>
                            <th class="p-3 text-left">URL</th>
                            <th class="p-3 text-left">Хост для пинга</th>
                            <th class="p-3 text-left">Действия</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for service in services %}
                        <tr class="border-t border-gray-800 hover:bg-gray-900/50 transition">
                            <td class="p-3">{{ service.name }}</td>
                            <td class="p-3">{{ service.url }}</td>
                            <td class="p-3">{{ service.ping_host }}</td>
                            <td class="p-3">
                                <a href="/delete_service/{{ service.id }}" class="text-red-400 hover:text-red-300">Удалить</a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Настройки -->
        <div class="mb-10 glass rounded-lg p-6 hover-scale">
            <h2 class="text-2xl font-semibold mb-4">Настройки</h2>
            <form action="/update_settings" method="POST" class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div>
                    <label class="block text-gray-400 mb-1">Интервал проверки (секунды)</label>
                    <input type="number" name="check_interval" value="{{ settings.check_interval if settings else 300 }}" class="glass p-3 rounded-lg text-white w-full focus:outline-none focus:ring-2 focus:ring-gray-500" required>
                </div>
                <div>
                    <label class="block text-gray-400 mb-1">Порог задержки (секунды)</label>
                    <input type="number" step="0.1" name="latency_threshold" value="{{ settings.latency_threshold if settings else 1.0 }}" class="glass p-3 rounded-lg text-white w-full focus:outline-none focus:ring-2 focus:ring-gray-500" required>
                </div>
                <div>
                    <label class="block text-gray-400 mb-1">Порог ошибок (количество)</label>
                    <input type="number" name="error_threshold" value="{{ settings.error_threshold if settings else 1 }}" class="glass p-3 rounded-lg text-white w-full focus:outline-none focus:ring-2 focus:ring-gray-500" required>
                </div>
                <div class="flex items-end">
                    <button type="submit" class="bg-gradient-to-r from-gray-700 to-gray-900 text-white p-3 rounded-lg w-full hover:bg-gray-800 transition">Сохранить настройки</button>
                </div>
            </form>
        </div>

        <!-- Статистика -->
        <div class="mb-10 glass rounded-lg p-6 hover-scale">
            <h2 class="text-2xl font-semibold mb-4">Статистика (последние 24 часа)</h2>
            <div id="stats" class="grid grid-cols-1 md:grid-cols-5 gap-4">
                <div class="p-4 glass rounded-lg">
                    <p class="text-gray-400">Всего проверок</p>
                    <p class="text-xl font-bold" id="total_checks">0</p>
                </div>
                <div class="p-4 glass rounded-lg">
                    <p class="text-gray-400">Инциденты</p>
                    <p class="text-xl font-bold" id="incidents">0</p>
                </div>
                <div class="p-4 glass rounded-lg">
                    <p class="text-gray-400">Среднее время отклика</p>
                    <p class="text-xl font-bold" id="avg_response_time">0с</p>
                </div>
                <div class="p-4 glass rounded-lg">
                    <p class="text-gray-400">Ошибки 4xx</p>
                    <p class="text-xl font-bold" id="errors_4xx">0</p>
                </div>
                <div class="p-4 glass rounded-lg">
                    <p class="text-gray-400">Ошибки 5xx</p>
                    <p class="text-xl font-bold" id="errors_5xx">0</p>
                </div>
            </div>
        </div>

        <!-- График -->
        <div class="glass rounded-lg p-6 hover-scale">
            <h2 class="text-2xl font-semibold mb-4">График времени отклика (последние 24 часа)</h2>
            <canvas id="responseTimeChart" class="w-full h-96"></canvas>
        </div>
    </div>

    <script>
        // Загрузка состояния сервисов
        function updateStatus() {
            fetch('/status')
                .then(response => response.json())
                .then(data => {
                    const statusElement = document.getElementById('status-text');
                    statusElement.textContent = data.status;
                    statusElement.className = `text-2xl font-semibold ${data.class}`;
                })
                .catch(error => {
                    console.error('Error fetching status:', error);
                    document.getElementById('status-text').textContent = 'Ошибка проверки состояния';
                    document.getElementById('status-text').className = 'text-2xl font-semibold bg-red-500';
                });
        }
        updateStatus(); // Загрузка состояния при открытии страницы
        setInterval(updateStatus, 60000); // Обновление каждые 60 секунд

        // Загрузка статистики
        fetch('/stats')
            .then(response => response.json())
            .then(data => {
                document.getElementById('total_checks').textContent = data.total_checks;
                document.getElementById('incidents').textContent = data.incidents;
                document.getElementById('avg_response_time').textContent = data.avg_response_time.toFixed(2) + 'с';
                document.getElementById('errors_4xx').textContent = data.errors_4xx;
                document.getElementById('errors_5xx').textContent = data.errors_5xx;
            });

        // Загрузка данных для графика
        fetch('/graph_data')
            .then(response => response.json())
            .then(data => {
                const ctx = document.getElementById('responseTimeChart').getContext('2d');
                const datasets = Object.keys(data).map(service => ({
                    label: service,
                    data: data[service].response_times,
                    borderColor: '#' + Math.floor(Math.random()*16777215).toString(16),
                    backgroundColor: 'rgba(255, 255, 255, 0.1)',
                    fill: false,
                    tension: 0.4
                }));
                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: data[Object.keys(data)[0]]?.timestamps || [],
                        datasets: datasets
                    },
                    options: {
                        scales: {
                            x: { 
                                title: { display: true, text: 'Время', color: '#9CA3AF' },
                                ticks: { color: '#9CA3AF' }
                            },
                            y: { 
                                title: { display: true, text: 'Время отклика (с)', color: '#9CA3AF' },
                                ticks: { color: '#9CA3AF' },
                                beginAtZero: true
                            }
                        },
                        plugins: {
                            legend: { labels: { color: '#9CA3AF' } }
                        }
                    }
                });
            });
    </script>
</body>
</html>
